name: Test Claude OAuth (Manual)

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Install keyring dependencies
        run: |
          sudo apt-get install -y gnome-keyring libsecret-tools dbus-x11

      - name: Setup gnome-keyring and store credentials
        env:
          CLAUDE_OAUTH_TOKEN: ${{ secrets.CLAUDE_OAUTH_TOKEN }}
        run: |
          # D-Bus 세션 시작
          eval $(dbus-launch --sh-syntax)
          echo "DBUS_SESSION_BUS_ADDRESS=$DBUS_SESSION_BUS_ADDRESS" >> $GITHUB_ENV

          # gnome-keyring 언락 (빈 패스워드)
          echo "" | gnome-keyring-daemon --unlock --daemonize
          echo "GNOME_KEYRING_CONTROL=$GNOME_KEYRING_CONTROL" >> $GITHUB_ENV

          # credentials JSON 생성
          CREDS=$(jq -n --arg token "$CLAUDE_OAUTH_TOKEN" '{
            claudeAiOauth: {
              accessToken: $token,
              refreshToken: "",
              expiresAt: 9999999999000,
              scopes: ["openid","profile","email","org:create"],
              subscriptionType: "claude_max",
              rateLimitTier: "max"
            }
          }')

          # keyring에 저장 (service=Claude Code-credentials, account=runner)
          echo "$CREDS" | secret-tool store \
            --label="Claude Code-credentials" \
            service "Claude Code-credentials" \
            account "$(whoami)"

          echo "=== Stored in keyring, verifying ==="
          secret-tool lookup service "Claude Code-credentials" account "$(whoami)" | head -c 50
          echo "..."

      - name: Test claude auth status
        run: claude auth status 2>&1 || true

      - name: Test simple prompt
        run: |
          claude -p "안녕이라고 한국어로 짧게 답해줘." --print 2>&1
