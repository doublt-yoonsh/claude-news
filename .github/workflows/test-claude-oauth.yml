name: Test Claude OAuth (Manual)

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Setup credentials
        env:
          CLAUDE_OAUTH_TOKEN: ${{ secrets.CLAUDE_OAUTH_TOKEN }}
        run: |
          mkdir -p ~/.claude
          jq -n --arg token "$CLAUDE_OAUTH_TOKEN" '{
            claudeAiOauth: {
              accessToken: $token,
              refreshToken: "",
              expiresAt: 9999999999000,
              scopes: ["openid","profile","email","org:create"],
              subscriptionType: "claude_max",
              rateLimitTier: "max"
            }
          }' > ~/.claude/.credentials.json
          echo "=== credentials.json ==="
          cat ~/.claude/.credentials.json | jq 'del(.claudeAiOauth.accessToken) + {claudeAiOauth: (.claudeAiOauth + {accessToken: "REDACTED"})}'

      - name: Test claude auth status
        run: claude auth status 2>&1 || true

      - name: Test simple prompt (env var fallback)
        env:
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.CLAUDE_OAUTH_TOKEN }}
        run: |
          claude -p "안녕이라고 한국어로 짧게 답해줘." --print 2>&1
