name: Test Claude OAuth (Manual)

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Inject mock keytar via NODE_OPTIONS preload
        env:
          CLAUDE_OAUTH_TOKEN: ${{ secrets.CLAUDE_OAUTH_TOKEN }}
        run: |
          CREDS=$(jq -n --arg token "$CLAUDE_OAUTH_TOKEN" '{
            claudeAiOauth: {
              accessToken: $token,
              refreshToken: "",
              expiresAt: 9999999999000,
              scopes: ["openid","profile","email","org:create"],
              subscriptionType: "claude_max",
              rateLimitTier: "max"
            }
          }')

          echo "=== auth status (NODE_OPTIONS preload) ==="
          NODE_OPTIONS="--require $PWD/scripts/keytar-preload.js" _CLAUDE_CREDS="$CREDS" claude auth status 2>&1 || true

          echo "=== prompt test (NODE_OPTIONS preload) ==="
          NODE_OPTIONS="--require $PWD/scripts/keytar-preload.js" _CLAUDE_CREDS="$CREDS" \
            claude -p "안녕이라고 한국어로 짧게 답해줘." --print 2>&1 || true
